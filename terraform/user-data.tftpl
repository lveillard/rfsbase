#!/bin/bash
set -euo pipefail
exec > >(tee /var/log/userdata.log) 2>&1
echo "=== RFSbase userdata.sh started at $(date) ==="

export DEBIAN_FRONTEND=noninteractive
HOME_DIR="/home/ubuntu"

# ---------------------------------------------------------------
# 1. System packages
# ---------------------------------------------------------------
apt-get update
apt-get upgrade -y
apt-get install -y \
  build-essential pkg-config libssl-dev \
  git curl wget tmux jq unzip \
  htop tree ripgrep fd-find \
  openssh-server locales gawk make \
  ca-certificates gnupg

# ---------------------------------------------------------------
# 2. Locale (full UTF-8)
# ---------------------------------------------------------------
locale-gen en_US.UTF-8
update-locale LANG=en_US.UTF-8
echo "LANG=en_US.UTF-8" > /etc/default/locale
export LANG=en_US.UTF-8
export LC_ALL=en_US.UTF-8

# ---------------------------------------------------------------
# 3. SSH server (for SSH-over-SSM tunnel)
# ---------------------------------------------------------------
systemctl enable --now ssh

# ---------------------------------------------------------------
# 4. SSM agent (snap-based on Ubuntu 24.04)
# ---------------------------------------------------------------
if systemctl is-active --quiet snap.amazon-ssm-agent.amazon-ssm-agent.service; then
  echo "SSM agent already running (snap)"
else
  snap start amazon-ssm-agent 2>/dev/null || true
fi

# ---------------------------------------------------------------
# 5. Swap (8 GB)
# ---------------------------------------------------------------
fallocate -l 8G /swapfile
chmod 600 /swapfile
mkswap /swapfile
swapon /swapfile
echo '/swapfile none swap sw 0 0' >> /etc/fstab

# ---------------------------------------------------------------
# 6. Docker (official Docker CE)
# ---------------------------------------------------------------
install -m 0755 -d /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
chmod a+r /etc/apt/keyrings/docker.gpg

echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
  $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \
  tee /etc/apt/sources.list.d/docker.list > /dev/null

apt-get update
apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

# Add ubuntu user to docker group
usermod -aG docker ubuntu

# Enable Docker
systemctl enable --now docker

# ---------------------------------------------------------------
# 7. Node.js 22 (for Claude Code CLI)
# ---------------------------------------------------------------
curl -fsSL https://deb.nodesource.com/setup_22.x | bash -
apt-get install -y nodejs

# ---------------------------------------------------------------
# 8. Claude Code CLI
# ---------------------------------------------------------------
npm install -g @anthropic-ai/claude-code

# ---------------------------------------------------------------
# 9. SSH key for ubuntu user (SSH-over-SSM access)
# ---------------------------------------------------------------
%{ if ssh_public_key != "" ~}
sudo -u ubuntu mkdir -p "$HOME_DIR/.ssh"
chmod 700 "$HOME_DIR/.ssh"
echo "${ssh_public_key}" >> "$HOME_DIR/.ssh/authorized_keys"
chmod 600 "$HOME_DIR/.ssh/authorized_keys"
chown -R ubuntu:ubuntu "$HOME_DIR/.ssh"
%{ endif ~}

# ---------------------------------------------------------------
# 10. Terminal fixes in /etc/profile
# ---------------------------------------------------------------
cat >> /etc/profile <<'STTYFIX'

# Terminal fixes for SSM sessions
stty sane 2>/dev/null
stty erase ^H 2>/dev/null
export TERM=xterm-256color
export LANG=en_US.UTF-8
export LC_ALL=en_US.UTF-8
STTYFIX

# ---------------------------------------------------------------
# 11. tmux config (system-wide)
# ---------------------------------------------------------------
cat > /etc/tmux.conf <<'TMUXCONF'
set -g default-shell /bin/bash
set -g default-command /bin/bash
set -g mouse on
set -g history-limit 50000
set -g default-terminal "tmux-256color"
set -ga terminal-overrides ",xterm-256color:Tc"
set -g status-right "#H | %H:%M"

# Better prefix
set -g prefix C-a
unbind C-b
bind C-a send-prefix

# Split panes with | and -
bind | split-window -h
bind - split-window -v

# Reload config
bind r source-file ~/.tmux.conf \; display "Config reloaded!"

# Status bar
set -g status-bg colour235
set -g status-fg white
set -g status-left-length 30
set -g status-left '#[fg=green](#S) '
TMUXCONF
cp /etc/tmux.conf "$HOME_DIR/.tmux.conf"
chown ubuntu:ubuntu "$HOME_DIR/.tmux.conf"

# ---------------------------------------------------------------
# 12. Auto-attach tmux for interactive sessions
# ---------------------------------------------------------------
cat > /etc/profile.d/tmux-auto.sh <<'TMUX_AUTO'
if [ -n "$PS1" ] && [ -z "$TMUX" ] && command -v tmux &>/dev/null; then
    export LANG=en_US.UTF-8
    export LC_ALL=en_US.UTF-8
    tmux -u new-session -A -s main
fi
TMUX_AUTO
chmod 644 /etc/profile.d/tmux-auto.sh

# ---------------------------------------------------------------
# 13. Bash aliases for docker
# ---------------------------------------------------------------
cat >> "$HOME_DIR/.bashrc" <<'BASHRC'

# RFSbase aliases
alias dc='docker compose'
alias dcup='docker compose -f docker-compose.ec2.yml up -d'
alias dcdown='docker compose -f docker-compose.ec2.yml down'
alias dclogs='docker compose -f docker-compose.ec2.yml logs -f'
alias dcps='docker compose -f docker-compose.ec2.yml ps'
alias dcbuild='docker compose -f docker-compose.ec2.yml build'

# Docker aliases
alias dps='docker ps'
alias dlog='docker logs -f'

# Navigation
alias proj='cd ~/rfsbase'

# Git
alias gs='git status'
alias gp='git pull'
alias gc='git commit'

# Colors
alias ls='ls --color=auto'
alias ll='ls -alF'
alias la='ls -A'
BASHRC
chown ubuntu:ubuntu "$HOME_DIR/.bashrc"

# ---------------------------------------------------------------
# 14. Git config
# ---------------------------------------------------------------
sudo -u ubuntu git config --global user.name "Loic Veillard"
sudo -u ubuntu git config --global user.email "loic@veillard.com"
sudo -u ubuntu git config --global init.defaultBranch main
sudo -u ubuntu git config --global pull.rebase false

# ---------------------------------------------------------------
# 15. Clone rfsbase repository
# ---------------------------------------------------------------
sudo -u ubuntu git clone https://github.com/lveillard/rfsbase.git "$HOME_DIR/rfsbase" || true

# ---------------------------------------------------------------
# 16. Create .env file placeholder
# ---------------------------------------------------------------
cat > "$HOME_DIR/rfsbase/.env" <<'ENV'
# RFSbase Environment Variables
# Fill in these values before running docker compose

# SurrealDB
SURREAL_USER=root
SURREAL_PASS=changeme_surreal_password
SURREAL_NS=rfsbase
SURREAL_DB=main

# Backend
JWT_SECRET=changeme_jwt_secret_min_32_chars
BETTER_AUTH_SECRET=changeme_auth_secret_min_32_chars
RESEND_API_KEY=
FROM_EMAIL=noreply@rfsbase.com
APP_URL=https://rfsbase.com
API_URL=https://rfsbase.com/api

# Frontend
NEXT_PUBLIC_API_URL=/api
NEXT_PUBLIC_APP_URL=https://rfsbase.com

# Caddy
CADDYFILE=./docker/Caddyfile.prod
ENV
chown ubuntu:ubuntu "$HOME_DIR/rfsbase/.env"

echo "=== RFSbase userdata.sh completed at $(date) ==="
echo "Installed: Docker, Docker Compose, Claude Code CLI, tmux"
echo ""
echo "Next steps:"
echo "1. SSH via: ssh ec2-rfsbase"
echo "2. Edit .env: nano ~/rfsbase/.env"
echo "3. Start: cd ~/rfsbase && docker compose -f docker-compose.ec2.yml up -d --build"
