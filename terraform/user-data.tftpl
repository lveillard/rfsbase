#!/bin/bash
set -euo pipefail
exec > >(tee /var/log/userdata.log) 2>&1

export DEBIAN_FRONTEND=noninteractive
HOME_DIR="/home/ubuntu"

# System packages
apt-get update && apt-get upgrade -y
apt-get install -y \
  build-essential pkg-config libssl-dev \
  git curl wget tmux jq unzip htop tree ripgrep fd-find \
  openssh-server locales gawk make ca-certificates gnupg

# Locale
locale-gen en_US.UTF-8
update-locale LANG=en_US.UTF-8

# SSH + SSM
systemctl enable --now ssh
snap start amazon-ssm-agent 2>/dev/null || true

# Swap 8GB
fallocate -l 8G /swapfile && chmod 600 /swapfile
mkswap /swapfile && swapon /swapfile
echo '/swapfile none swap sw 0 0' >> /etc/fstab

# Docker
install -m 0755 -d /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
chmod a+r /etc/apt/keyrings/docker.gpg
echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
apt-get update
apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
usermod -aG docker ubuntu
systemctl enable --now docker

# Node.js + Claude Code
curl -fsSL https://deb.nodesource.com/setup_22.x | bash -
apt-get install -y nodejs
npm install -g @anthropic-ai/claude-code

# SSH key
%{ if ssh_public_key != "" ~}
sudo -u ubuntu mkdir -p "$HOME_DIR/.ssh"
chmod 700 "$HOME_DIR/.ssh"
echo "${ssh_public_key}" >> "$HOME_DIR/.ssh/authorized_keys"
chmod 600 "$HOME_DIR/.ssh/authorized_keys"
chown -R ubuntu:ubuntu "$HOME_DIR/.ssh"
%{ endif ~}

# Terminal fixes
cat >> /etc/profile <<'EOF'
stty sane 2>/dev/null; stty erase ^H 2>/dev/null
export TERM=xterm-256color LANG=en_US.UTF-8 LC_ALL=en_US.UTF-8
EOF

# tmux
cat > /etc/tmux.conf <<'EOF'
set -g default-shell /bin/bash
set -g mouse on
set -g history-limit 50000
set -g default-terminal "tmux-256color"
set -g prefix C-a
unbind C-b
bind C-a send-prefix
bind | split-window -h
bind - split-window -v
EOF
cp /etc/tmux.conf "$HOME_DIR/.tmux.conf"
chown ubuntu:ubuntu "$HOME_DIR/.tmux.conf"

# Auto-tmux
cat > /etc/profile.d/tmux-auto.sh <<'EOF'
[ -n "$PS1" ] && [ -z "$TMUX" ] && command -v tmux &>/dev/null && tmux -u new-session -A -s main
EOF

# Aliases
cat >> "$HOME_DIR/.bashrc" <<'EOF'
alias dc='docker compose'
alias dcup='docker compose -f docker-compose.ec2.yml up -d'
alias dcdown='docker compose -f docker-compose.ec2.yml down'
alias dclogs='docker compose -f docker-compose.ec2.yml logs -f'
alias dcps='docker compose -f docker-compose.ec2.yml ps'
alias dps='docker ps'
alias proj='cd ~/rfsbase'
alias gs='git status'
alias ll='ls -alF --color=auto'
EOF
chown ubuntu:ubuntu "$HOME_DIR/.bashrc"

# Git
sudo -u ubuntu git config --global user.name "Loic Veillard"
sudo -u ubuntu git config --global user.email "loic@veillard.com"
sudo -u ubuntu git config --global init.defaultBranch main

# Clone repo
sudo -u ubuntu git clone https://github.com/lveillard/rfsbase.git "$HOME_DIR/rfsbase" || true

# Backup config
echo "${backup_bucket}" > "$HOME_DIR/.rfsbase-backup-bucket"
chown ubuntu:ubuntu "$HOME_DIR/.rfsbase-backup-bucket"
chmod +x "$HOME_DIR/rfsbase/deploy/backup-to-s3.sh" "$HOME_DIR/rfsbase/deploy/restore-from-s3.sh" 2>/dev/null || true

cat > /etc/cron.d/rfsbase-backup <<EOF
0 3 * * * ubuntu BACKUP_BUCKET=${backup_bucket} /home/ubuntu/rfsbase/deploy/backup-to-s3.sh >> /var/log/rfsbase-backup.log 2>&1
EOF

# Secrets from AWS Secrets Manager
%{ if use_secrets_manager && secrets_arn != "" ~}
SECRETS=$(aws secretsmanager get-secret-value --secret-id "${secrets_arn}" --query SecretString --output text --region ${aws_region})

cat > "$HOME_DIR/rfsbase/.env" <<ENVFILE
SURREAL_USER=root
SURREAL_PASS=$(echo "$SECRETS" | jq -r '.SURREAL_PASS')
SURREAL_NS=rfsbase
SURREAL_DB=main
JWT_SECRET=$(echo "$SECRETS" | jq -r '.JWT_SECRET')
BETTER_AUTH_SECRET=$(echo "$SECRETS" | jq -r '.BETTER_AUTH_SECRET')
RESEND_API_KEY=$(echo "$SECRETS" | jq -r '.RESEND_API_KEY // empty')
OPENAI_API_KEY=$(echo "$SECRETS" | jq -r '.OPENAI_API_KEY // empty')
FROM_EMAIL=noreply@rfsbase.com
APP_URL=https://${domain}
API_URL=https://${domain}/api
NEXT_PUBLIC_API_URL=/api
NEXT_PUBLIC_APP_URL=https://${domain}
CADDYFILE=./docker/Caddyfile.prod
ENVFILE
%{ else ~}
cat > "$HOME_DIR/rfsbase/.env" <<'ENVFILE'
SURREAL_USER=root
SURREAL_PASS=CHANGEME
SURREAL_NS=rfsbase
SURREAL_DB=main
JWT_SECRET=CHANGEME_MIN_32_CHARS
BETTER_AUTH_SECRET=CHANGEME_MIN_32_CHARS
APP_URL=http://localhost
NEXT_PUBLIC_API_URL=/api
CADDYFILE=./docker/Caddyfile.ec2
ENVFILE
%{ endif ~}

chown ubuntu:ubuntu "$HOME_DIR/rfsbase/.env"
chmod 600 "$HOME_DIR/rfsbase/.env"

echo "Setup complete. Run: cd ~/rfsbase && docker compose -f docker-compose.ec2.yml up -d --build"
